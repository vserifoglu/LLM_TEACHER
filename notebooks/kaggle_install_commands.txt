# REVISION 3: Fix Protobuf "Descriptor" Error
# The error happens because Tunix pulls a new Protobuf (Version 5+), but Kaggle's pre-installed
# Google Cloud libraries (automl, storage) are old and crash with new Protobuf.
# FIX: Use the --upgrade flag on google-cloud libraries.

# 1. Cleanup legacy potential blockers
!pip uninstall -q -y gensim bigframes cudf-cu12 pylibcugraph-cu12 tensorflow-decision-forests tf-keras flax jax jaxlib tensorflow

# 2. Upgrade Google Cloud SDKs FIRST to make them compatible with new Protobuf
!pip install -U -q google-cloud-storage google-cloud-automl google-cloud-bigquery protobuf

# 3. Enable Numpy 2.0 stack
!pip install -q "numpy>=2.0" "ml_dtypes>=0.4.0"

# 4. Install Main Libraries
!pip install -q \
    "flax==0.12.0" \
    "google-tunix[prod]==0.1.3" \
    "wandb==0.22.0" \
    kagglehub \
    ipywidgets \
    tensorflow \
    tensorflow_datasets \
    tensorboardX \
    transformers \
    grain \
    datasets

# PLEASE RESTART SESSION AFTER RUNNING THIS IF YOU HAVEN'T ALREADY
# But since you just verified, try running *just* step 2 in a new cell if you don't want to reinstall everything.
# Better yet, run the whole block fresh to be sure.
